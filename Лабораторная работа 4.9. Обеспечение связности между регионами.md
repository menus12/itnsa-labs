## Лабораторная работа 4.9. Обеспечение связности между регионами

### Описание сценария

В глобальной инфраструктуре публичного облачного провайдера часто ресурсы располагаются в разных географических регионах для обеспечения отказоустойчивости. Чтобы обеспечить связность таких ресурсов на уровне сети не маршрутизируя трафик черз публичную сеть интернет, необходима конфигурация глобального пиринга между виртуальными сетями в каждом регионе.

В данном сценарии системный администратор разворачивает две виртуальные машины в разных географических регионах и обеспечивает их сетевую связность.

### Задачи лабораторной работы

- Создать две виртуальные машины в разных регионах
- Создать глобальный пиринг между виртуальными сетями в разных регионах

### Создание виртуальных машин в разных регионах

1. Войдите на портал Azure по адресу **portal.azure.com** под вашей учетной записью.
2. Создайте группу ресурсов или используйте группу ресурсов, выделенную для вашей учетной записи.
3. Создайте виртуальные машины согласно следующим основным параметрам:

| **Параметр** | **Значение** |
| --- | --- |
| Подписка | Использовать предоставленное по умолчанию |
| Группа ресурсов | Использовать предоставленное по умолчанию |
| Имя виртуальной машины | vm1 и vm2 соответственно |
| Регион | (US) Восточный регион США и (US) Восточный регион США 2 соответственно |
| Параметры доступности | Избыточность параметров инфраструктуры не требуется |
| Образ | Windows Server 2019 Datacenter, поколение 1 |
| Размер | Standard D2s v3 |
| Имя пользователя | azureuser |
| Пароль (внимательно следите за правильностью ввода!) | Pa$$w0rd1234 |
| Общедоступные входящие порты | Разрешить выбранные порты |
| Выбрать входящие порты | RDP (3389) |

4. На вкладке «**Диски**» выберите тип ОС диска SSD (цен. Категория «Стандартный»).
5. Нажмите «**Просмотр и создание**» (Review + Create) в нижней части страницы. Ознакомьтесь с параметрами и нажмите «**Создать**» (Create). Создание виртуальной машины займет несколько минут, информация об окончании процесса появится в верхней панели уведомлений.

### Проверка связности по умолчанию

1. На портале Azure откройте виртуальную машину **vm2**. В окне с общей информацией идентифицируйте частный IP-адрес данной виртуальной машины.

![](/assets/pics/4.9.1.png "Рис. 4.9.1. Окно с информацией о виртуальной машине")

2. Аналогично откройте виртуальную машину **vm1** и убедитесь, что данные виртуальные машины расположены в разных подсетях.
3. Подключитесь к виртуальной машине **vm1** по RDP. Откройте терминал PowerShell.
4. Проверьте связность с виртуальной машиной **vm2** с помощью команды **Test-NetConnection  -ComputerName 10.2.0.4 -Port 3389 -InformationLevel &#39;Detailed&#39;**.

```
PS C:\Users\azureuser> Test-NetConnection -ComputerName 10.2.0.4 -Port 3389 -InformationLevel 'Detailed'
WARNING: TCP connect to (10.2.0.4 : 3389) failed
WARNING: Ping to 10.2.0.4 failed with status: TimedOut

ComputerName            : 10.2.0.4
RemoteAddress           : 10.2.0.4
RemotePort              : 3389
NameResolutionResults   : 10.2.0.4
MatchingIPsecRules      :
NetworkIsolationContext : Internet
InterfaceAlias          : Ethernet
SourceAddress           : 10.1.0.4
NetRoute (NextHop)      : 10.1.0.1
PingSucceeded           : False
PingReplyDetails (RTT)  : 0 ms
TcpTestSucceeded        : False
```

В данном примере связность проверяется через TCP порт 3389, так как это единственное правило для входящего из вне трафика, которое было создано в процессе создания виртуальной машины. Так как каждая виртуальная машина расположена в своей изолированной виртуальной сети, проверка связи не будет успешной.

### Создание пиринга между изолированными подсетями и проверка связности

1. В глобальном каталоге ресурсов выберите «Виртуальные сети». В открывшемся окне вы должны увидеть две виртуальные сети, созданные автоматически при создании каждой из виртуальных машин.
2. Нажмите на имя сети, которая расположена в «**Восточном регионе США**». В открывшемся окне в левой панели в разделе «**Настройки**» выберите «**Пиринги**» и в верхней панели управления нажмите «**Добавить**».
3. В открывшемся окне в разделе «**Эта виртуальная сеть**» задайте имя пиринговой сети «**east-to-east 2**», в разделе «**Удаленная виртуальная сеть**» задайте имя пиринговой сети «**east2-to-east**».
4. Оставьте остальные параметры по умолчанию и нажмите «**Добавить**».
5. В верхней панели нажмите «**Обновить**». Убедитесь в том, что в разделе «**Пиринги**» появился добавленный пиринг «**east-to-east2**» в состоянии «**Подключено**». Аналогично во второй виртуальной сети в разделе «**Пиринги**» появился пиринг «**east2-to-east**».
6. В терминале PowerShell виртуальной машины **vm1** повторите проверку связности командой **Test-NetConnection -ComputerName 10.2.0.4 -Port 3389 -InformationLevel &#39;Detailed&#39;**. После создания глобального пиринга между подсетями, в которых располагаются виртуальные машины **vm1** и **vm2**, проверка связности должна пройти успешно.


```
PS C:\Users\azureuser> Test-NetConnection -ComputerName 10.2.0.4 -Port 3389 -InformationLevel 'Detailed'

ComputerName            : 10.2.0.4
RemoteAddress           : 10.2.0.4
RemotePort              : 3389
NameResolutionResults   : 10.2.0.4
MatchingIPsecRules      :
NetworkIsolationContext : Internet
InterfaceAlias          : Ethernet
SourceAddress           : 10.1.0.4
NetRoute (NextHop)      : 10.1.0.1
TcpTestSucceeded        : True
```
