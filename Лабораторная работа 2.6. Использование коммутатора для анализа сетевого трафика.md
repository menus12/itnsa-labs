## Лабораторная работа 2.6. Использование коммутатора для анализа сетевого трафика

### Описание сценария

Функция зеркалирования портов (англ. port mirroring) коммутатора для мониторинга трафика в сети является важной функциональной особенностью коммутаторов. Зеркалирование трафика может применяться с целью поиска неисправностей или анализа работы приложений. Однако, чаще всего применяется в информационной безопасности (ИБ) для анализа сетевого трафика с целью поиска угроз ИБ. В этом случае сетевой трафик перенаправляется (зеркалируется) на специализированные аппаратно-программные устройства поиска (предотвращения) угроз IDS/IPS системы или их аналоги. На коммутаторах компании Cisco функция зеркалирования называется SPAN – Switch Port Analyzer. Архитектурно функция зеркалирования состоит из трех компонентов – источника трафика, одного или нескольких коммутаторов, анализатора трафика. Различают несколько видов зеркалирования сетевого трафика:

- **Локальное зеркалирование (SPAN)** — когда источник и анализатор трафика подключены к одному коммутатору.
- **Удаленное зеркалирование (RSPAN – remote SPAN)** — когда источник и анализатор трафика подключены к разным коммутаторам.
- **Удаленное зеркалирование с маршрутизацией (ERSPAN – encapsulated remote SPAN)** — когда источник и анализатор трафика разделены L3 сегментом. В этом случае зеркалированный трафик передается в GRE туннеле. Данный метод зеркалирования не рассматривается в данной лабораторной работе.

### Задачи лабораторной работы

- Получить информацию о содержимом ICMP трафика используя SPAN
- Получить информацию о содержимом HTTP-запросов используя RSPAN

### Описание топологии

Топология состоит из трех коммутаторов IOSvL2 – SW00-SW02, два компьютера пользователя в качестве источника трафика Client01-Client02, WEB-сервера Server, анализатора трафика Analyzer.

![](/assets/pics/2.6.1.png "Рис. 2.6.1. Топология")

### Начальное состояние и базовые настройки устройств

- Все порты коммутаторов, связывающие коммутаторы друг с другом настроены в режиме trunk.
- Создан VLAN 100.
- ПК помещены в VLAN в соответствии с таблицей

| **Имя в лабораторной работе** | **VLAN** | **IP адрес** |
| --- | --- | --- |
| Client01 | 100 | 10.0.100.1/24 |
| Client02 | 100 | 10.0.100.2/24 |
| Server | 100 | 10.0.100.200/24 |
| Analyzer | 200 | 10.0.200.1/24 |

### Предварительная настройка

1. На **ПК Client 01** настройте адрес на сетевом интерфейсе 10.0.100.1/24 с помощью команды **sudo ip addr add 10.0.100.1/24 dev ens2**.
2. На **ПК Client 02** настройте адрес на сетевом интерфейсе 10.0.100.2/24.
3. На **ПК Server** настройте адрес на сетевом интерфейсе 10.0.100.200/24.
4. На **ПК Analyzer** настройте адрес на сетевом интерфейсе 10.0.200.1/24.
5. Убедитесь, что все **ПК Client 01,  Client 02, Server** могут пинговать друг друга.

### Локальное зеркалирование (SPAN)

1. Для настройки локального зеркалирования трафика на коммутаторе SW02 с порта G0/1 на ПК Analyzer (порт G0/0) введите следующие команды:

```
SW02#configure terminal 
SW02(config)#monitor session 1 source interface g0/1
SW02(config)#monitor session 1 destination interface g0/0
```

**Примечание**

---

Команда **# monitor session** позволяет создать задачу зеркалирования сетевого трафика. Разные задачи отличаются друг от друга номерами. В данном случае мы создаем задачу зеркаливарония трафика с номером 1, где источником трафика является порт G0/1 коммутатора SW02, а получателем порт G0/0.

---

1. На ПК Client02 запустите ping до ПК Client01 с помощью команды **ping 10.0.100.1 -p  5f495f4b4e4f575f434953434f**. Что значит 5f495f4b4e4f575f434953434f?
2. На ПК Analyzer запустим программу tcpdump для захвата зеркалированного сетевого трафика на интерфейсе ПК.

```
cisco@Analyzer:~$ sudo tcpdump -v
tcpdump: listening on ens2, link-type EN10MB (Ethernet), capture size 262144 bytes
16:34:14.278351 IP (tos 0x0, ttl 64, id 40695, offset 0, flags [DF], proto ICMP (1), length 84)
    10.0.100.2 > 10.0.100.1: ICMP echo request, id 4, seq 14, length 64
16:34:14.289487 IP (tos 0x0, ttl 64, id 42919, offset 0, flags [none], proto ICMP (1), length 84)
    10.0.100.1 > 10.0.100.2: ICMP echo reply, id 4, seq 14, length 64
```

3. В консоли ПК Analyzer видно, что получен зеркалированный сетевой трафик между ПК Client01 и ПК Client02. Видны ICMPecho запросы с ПК Client02 и ICMPecho ответы с ПК Client02. Используя различные опции tcpdump можно получать дополнительную информацию, так опции **tcpdump -e  -X** позволяют проанализировать Ethernet заголовок, а также декодировать данные из пакетов.

```
cisco@Analyzer:~$ sudo tcpdump -X -e
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens2, link-type EN10MB (Ethernet), capture size 262144 bytes
16:51:38.042794 52:54:00:11:20:41 (oui Unknown) > 52:54:00:0a:e7:7e (oui Unknown), ethertype IPv4 (0x0800), length 98: 10.0.100.2 > 10.0.100.1: ICMP echo request, id 6, seq 6, length 
0x0000:  4500 0054 990a 4000 4001 c59b 0a00 6402  E..T..@.@.....d.
0x0010:  0a00 6401 0800 fb18 0007 0007 9e44 df60  ..d..........D.`
0x0020:  0000 0000 18f9 0700 0000 0000 4b4e 4f57  ............KNOW
0x0030:  5f43 4953 434f 5f49 5f4b 4e4f 575f 4349  _CISCO_I_KNOW_CI
0x0040:  5343 4f5f 495f 4b4e 4f57 5f43 4953 434f  SCO_I_KNOW_CISCO
0x0050:  5f49 5f4b                                _I_K
```

4. Удалите задачу зеркалирования трафика с помощью команды **no monitor session**

###Удаленное зеркалирование (RSPAN – remote SPAN)

1. Для удаленного зеркалирования трафика используется специальный транспортный VLAN для зеркалирования трафика. Он отличается от обычного VLAN тем, что в него нельзя поместить порты уровня доступа (accessports). Для создания транспортного **VLAN 111** на коммутаторах **SW00-SW02** введите следующую команду remote-span при создании VLAN:

```
SW0X#conf t
SW0X(config)#vlan 111
SW0X(config-vlan)#remote-span 
SW0X(config-vlan)#exit
```

2. Для демонстрации работы удаленного зеркалирования мы будем анализировать трафик между ПК Client01 и ПК Server. Как видно из диаграммы эти ПК подключены к разным коммутаторам. И очевидно, что анализировать трафик между ПК используя локальное зеркалирование уже невозможно. Создадим задачи зеркалирования трафика с использованием транспортного VLAN 111 в качестве получателя зеркалированного трафика на коммутаторах SW00-SW01.

```
SW0X#conf t
SW0X#configure terminal 
SW0X(config)#monitor session 1 source interface g0/0      
SW0X(config)#monitor session 1 destination remote vlan 111
```

3. На коммутаторе SW02 создадим новую задачу удаленного зеркалирования трафика. В этой задаче источником зеркалированного трафика будет транспортный VLAN 111, а получателем ПК Analyzer на порту G0/0

```
SW02#configure terminal 
SW02(config)#monitor session 2 source remote vlan 111    
SW02(config)#monitor session 2 destination interface g0/0
```

4. На ПК Analyzer запускаем анализ сетевого трафика в расширенном режиме:

```
cisco@Analyzer:~$ sudo tcpdump -X
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens2, link-type EN10MB (Ethernet), capture size 262144 bytes
```

5. Для проверки работы удаленного зеркалирования трафика на ПК Server создадим простую html страничку и запустим HTTP-сервер с помощью модуля python (команда выполняется в одну строку):

```
cisco@Server:~$ echo "<html><body><H1>I AM A NETWORK MASTER</H1></body></html>" > index.html
```

6. Запускаем HTTP-сервер. Обратите внимание, по умолчанию сервер запускается на порту 8000:

```
cisco@Server:~$ python3 -m http.server 
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

7. На ПК Client01 загружаем файл index.html с помощью утилиты curl:

```
cisco@Client01:~$ curl 10.0.100.200:8000/index.html
<html><body><H1>I AM A NETWORK MASTER</H1></body></html>
```

8. В консоли ПК Analyzer видно, как происходила загрузка файла по протоколу HTTP (вывод сокращен для краткости представления):

```
cisco@Client01:~$ curl 10.0.100.200:8000/index.html
14:49:37.243624 IP 10.0.100.200.8000 > 10.0.100.1.44166: Flags [FP.], seq 185:242, ack 92, win 509, options [nop,nop,TS val 2535991418 ecr 2970816433], length 57
0x0000:  4500 006d d7ea 4000 4006 85d7 0a00 64c8  E..m..@.@.....d.
0x0010:  0a00 6401 1f40 ac86 dac8 d248 a909 5c30  ..d..@.....H..\0
0x0020:  8019 01fd 6b9f 0000 0101 080a 9728 287a  ....k........((z
0x0030:  b113 0fb1 3c68 746d 6c3e 3c62 6f64 793e  ....<html><body>
0x0040:  3c48 313e 4920 414d 2041 204e 4554 574f  <H1>I.AM.A.NETWO
0x0050:  524b 204d 4153 5445 523c 2f48 313e 3c2f  RK.MASTER</H1></
0x0060:  626f 6479 3e3c 2f68 746d 6c3e 0a         body></html>.     
```
