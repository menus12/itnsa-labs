## Лабораторная работа 4.7. Безопасность сетевых подключений

### Описание сценария

При использовании сервисов публичного облачного провайдера крайне важным является контролировать доступ к создаваемым ресурсам из публичной сети интернет. Базовые методы контроля реализуются с помощью групп сетевой безопасности.

В данном сценарии системный администратор создает виртуальную машину и настраивает группу сетевой безопасности, чтобы ограничить к ней доступ из публичной сети.

### Задачи лабораторной работы

- Создать виртуальную машины
- Создать группу сетевой безопасности
- Настроить правила для входящего и исходящего сетевого трафика

### Создание виртуальной машины

1. Войдите на портал Azure по адресу **portal.azure.com** под вашей учетной записью.
2. Создайте группу ресурсов или используйте группу ресурсов, выделенную для вашей учетной записи.
3. Создайте виртуальную машину согласно следующим основным параметрам:

| **Параметр** | **Значение** |
| --- | --- |
| Подписка | Использовать предоставленное по умолчанию |
| Группа ресурсов | Использовать предоставленное по умолчанию |
| Имя виртуальной машины | SimpleWinVM |
| Регион | (US) Восточный регион США |
| Параметры доступности | Избыточность параметров инфраструктуры не требуется |
| Образ | Windows Server 2019 Datacenter, поколение 1 |
| Размер | Standard D2s v3 |
| Имя пользователя | azureuser |
| Пароль (внимательно следите за правильностью ввода!) | Pa$$w0rd1234 |
| Общедоступные входящие порты | Нет |

1. На вкладке «**Диски**» выберите тип ОС диска **SSD (цен. Категория «Стандартный»)**.
2. На вкладке «**Сетевые подключения**» выберите «**Нет**» в разделе «**Группа безопасности сети сетевого адаптера**». Оставьте примененные параметры по умолчанию.
3. На вкладке «**Управление**» отключите диагностику загрузки.
4. Нажмите «**Просмотр и создание**» (Review + Create) в нижней части страницы. Ознакомьтесь с параметрами и нажмите «**Создать**» (Create). Создание виртуальной машины займет несколько минут, информация об окончании процесса появится в верхней панели уведомлений.

### Создание группы сетевой безопасности

1. Перейдите к созданной виртуальной машине. В левом меню выберите «**Сетевые подключения**». Обратите внимание на то, что текущий сетевой интерфейс не привязан к каким-либо группам сетевой безопасности.

![](/assets/pics/4.7.1.png "Рис. 4.7.1. Сетевые подключения виртуальной машины")

2. В меню служб выберите «**Все службы**» и в категории «**Сети**» выберите «**Группы безопасности сети**», нажмите «**Создать**». В появившемся окне нажмите «**Создать**».

![](/assets/pics/4.7.2.png "Рис. 4.7.2. Службы категории «Сети»")

3. Выберите доступную вам подписку и группу ресурсов, задайте имя **myNSGSecure** , выберите «**Восточный регион США**», нажмите «**Просмотр и создание**» (Review + create). Проверьте параметры и нажмите «**Создать**» (Create).
4. После создания группы безопасности сети щелкните «**Перейти к ресурсу**». В разделе «**Настройки**» выберите «**Сетевые интерфейсы**», в верхней панели нажмите «**Привязать**». В открывшейся панели справа выберите сетевой интерфейс созданной виртуальной машины и нажмите «**ОК**». Убедитесь в том, что сетевой интерфейс успешно привязан к группе сетевой безопасности.

![](/assets/pics/4.7.3.png "Рис. 4.7.3. Привязка интерфейса к группе сетевой безопасности")

### Настройка правил входящего трафика

1. В левом меню в разделе настройки выберите «**Правила безопасности для входящего трафика**» и ознакомьтесь со входящими правилами по умолчанию. Первое правило (**AllowVnetInBound**) разрешает весь трафик внутри виртуальной сети, второе правило (**AllowAzureLoadBalancerInBound**) разрешает любой входящий трафик от балансировщика нагрузки (**AzureLoadBalancer**), а третье правило (**DenyAllInBound**) запрещает весь остальной трафик.

| ![](RackMultipart20211206-4-10scpf7_html_4d753fff9d74a13d.png) |
| --- |
![](/assets/pics/4.7.4.png "Рис. 4.7.4. Правила входящего трафика по умолчанию")

2. Попытайтесь подключиться к виртуальной машине с помощью RDP, загрузив RDP-файл и запустив его. Попытка подключения не будет успешной, так как в группе безопасности, которая привязана к сетевому интерфейсу виртуальной машины отсутствуют правила входящего трафика по протоколу RDP.
3. Вернитесь к правилам для входящего трафика созданной группы сетевой безопасности и в верхней панели управления нажмите «**Добавить**». В открывшейся правой панели добавьте правило используя следующие параметры:

| **Параметр** | **Значение** |
| --- | --- |
| Источник | Любой (Any) |
| Диапазоны исходных портов | \* |
| Место назначения | Любой (Any) |
| Служба | Custom |
| Диапазоны портов назначения | 3389 |
| Протокол | TCP |
| Действие | Разрешить |
| Приоритет | 300 |
| Имя | AllowRDP |

4. В верхней панели нажмите «**Обновить**» и убедитесь в том, что созданное правило отобразилось.
5. Повторите подключение к виртуальной машине с помощью RDP, подключение должно пройти успешно.

### Настройка правил исходящего трафика

1. Внутри виртуальной машины запустите терминал PowerShell и проверьте доступность любого интернет-ресурса с помощью команды **ping**. Проверка доступности должна пройти успешно.

```
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\azureuser> ping ya.ru

Pinging ya.ru [87.250.250.242] with 32 bytes of data:
Reply from 87.250.250.242: bytes=32 time=122ms TTL=44
Reply from 87.250.250.242: bytes=32 time=122ms TTL=44
Reply from 87.250.250.242: bytes=32 time=122ms TTL=44
Reply from 87.250.250.242: bytes=32 time=122ms TTL=44

Ping statistics for 87.250.250.242:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 122ms, Maximum = 122ms, Average = 122ms
```

1. Вернитесь в параметры группы сетевой безопасности на портале Azure и в левом меню в разделе «**Настройки**» выберите «**Правила безопасности для исходящего трафика**». Обратите внимание на правила исходящего трафика по умолчанию, которые разрешают весь исходящий трафик в рамках виртуальной сети, а также в публичный интернет.
2. В верхней панели нажмите «Добавить» и в появившейся правой панели создайте правило со следующими параметрами:

| **Параметр** | **Значение** |
| --- | --- |
| Источник | Любой (Any) |
| Диапазоны исходных портов | \* |
| Место назначения | Тег службы (Service Tag) |
| Тег службы назначения | Internet |
| Служба | Custom |
| Диапазоны портов назначения | \* |
| Протокол | Any |
| Действие | Запретить |
| Приоритет | 300 |
| Имя | DenyInternet |

3. В верхней панели нажмите «**Обновить**» и убедитесь, что правило создано.
4. Вернитесь в окно RDP созданной виртуальной машины, попробуйте повторить проверку доступности с помощью команды **ping**. Так как исходящий трафик в интернет сейчас запрещен созданным правилом, проверка связности не должна завершиться успешно.

```
PS C:\Users\azureuser> ping ya.ru

Pinging ya.ru [87.250.250.242] with 32 bytes of data:
Request timed out.
Request timed out.
Request timed out.
Request timed out.

Ping statistics for 87.250.250.242:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),
```
