## Лабораторная работа 4.10. Управление трафиком

### Описание сценария

При расширении локальной инфраструктуры часто бывают случаи, когда часть нагрузки в облаке должна быть связана по сети с локальной инфраструктурой. Несмотря на то, что облачные провайдеры предоставляют стандартные средства для организации такой гибридной инфраструктуры, часто более удобным решением является создание на границе публичной сети в облаке специализированных платформ управления трафиком, таких как виртуальные маршрутизаторы.

В данном сценарии системный администратор тестирует перенаправление трафика виртуальной машины через виртуальный маршрутизатор, развернутый на границе публичной сети в облаке Azure.

### Задачи лабораторной работы

- Создать виртуальный маршрутизатор CiscoCSR 1000v
- Создать виртуальную машину
- Настроить прохождение трафика виртуальной машины через виртуальный маршрутизатор

### Создание виртуального маршрутизатора Cisco Cloud Services Router  1000 V

1. Войдите на портал Azure по адресу **portal.azure.com** под вашей учетной записью.
2. Создайте группу ресурсов или используйте группу ресурсов, выделенную для вашей учетной записи.
3. Перейдите в вашу группу ресурсов и в верхней панели управления нажмите «**Создать**». В строке поиска служб и Marketplace введите «**cisco**» и нажмите ввод. В результатах поиска установите фильтр «**Тип продукта: Virtual Machine**». Выберите «**Cisco Cloud Services Router (CSR) 1000V**».

![](/assets/pics/4.10.1.png "Рис. 4.10.1. Результаты поиска Marketplace")

4. В открывшемся окне выберите последнюю доступную версию ОС плана «**Bring Your Own License**» и нажмите «**Создать**».
5. Создайте виртуальную машину согласно следующим основным параметрам:

| **Параметр** | **Значение** |
| --- | --- |
| Подписка | Использовать предоставленное по умолчанию |
| Группа ресурсов | Использовать предоставленное по умолчанию |
| Имя виртуальной машины | csr |
| Регион | (US) Восточный регион США и (US) Восточный регион США 2 соответственно |
| Параметры доступности | Избыточность инфраструктуры не требуется |
| Образ | (оставить по умолчанию) |
| Размер | Standard D2s v3 |
| Тип проверки подлинности | Пароль |
| Имя пользователя | azureuser |
| Пароль (внимательно следите за правильностью ввода!) | Pa$$w0rd1234 |

6. На вкладке «**Диски**» выберите тип ОС диска SSD (цен. Категория «Стандартный»).
7. Нажмите «**Просмотр и создание**» (Review + Create) в нижней части страницы. Ознакомьтесь с параметрами и нажмите «**Создать**» (Create). Создание виртуальной машины займет несколько минут, информация об окончании процесса появится в верхней панели уведомлений.

### Создание внутренней подсети и дополнительного сетевого адаптера

1. В глобальном каталоге ресурсов перейдите в раздел «**Виртуальные сети**» и выберите виртуальную сеть в вашей группе ресурсов. В левом меню в разделе «**Настройки**» выберите «**Подсети**». Обратите внимание на созданную по умолчанию подсеть **default** с префиксом **10.1.0.0/24**. В верхней панели нажмите «**+Подсеть**».
2. Задайте internal в качестве имени новой подсети, оставьте остальные параметры по умолчанию и нажмите «**Сохранить**».
3. В глобальном каталоге ресурсов выберите «**Сетевые интерфейсы**», в верхней панели нажмите «**Добавить**».
4. В открывшемся окне задайте имя **csr300** и выберите виртуальную сеть, созданную на предыдущем шаге. Оставьте остальные параметры по умолчанию и нажмите «**Просмотр и создание**» (Review + Create), проверьте параметры и нажмите «**Создать**» (Create).

![](/assets/pics/4.10.2.png "Рис. 4.10.2. Добавление сетевого адаптера")

1. Перейдите к созданной виртуальной машине **csr** и в верхней панели управления нажмите «**Остановить**».
2. После того, как состояние смениться с **Running** на **Stopped (Deallocated)**, в левом меню в разделе «Настройки» выберите «**Сетевые подключения**». В верхней панели нажмите на «**Подключение сетевого интерфейса**». В диалоговом окне появится сетевой интерфейс, который вы создали ранее (**csr300**), нажмите «**ОК**».
3. Вернитесь к обзору виртуальной машины **csr** и в верхней панели управления нажмите «**Пуск**».

### Подключение к виртуальному маршрутизатору

1. После того, как состояние виртуальной машины **csr** смениться на **Running** , определите и скопируйте в буфер обмена общедоступный IP-адрес.

![](/assets/pics/4.10.3.png "Рис. 4.10.3. Обзор виртуальной машины csr")

2. На вашем локальном компьютере откройте интерфейс командной строки (**cmd**) или **PowerShell**. Подключитесь к виртуальному маршрутизатору по SSH с помощью команды **ssh azuser@общедоступный-ip-адрес**.

```
Microsoft Windows [Version 10.0.18363.1916]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\Users\menus12>ssh azureuser@20.115.26.143
The authenticity of host '20.115.26.143 (20.115.26.143)' can't be established.
RSA key fingerprint is SHA256:U899HXOhCdEMWPSWquvjRUxUB61OuZNqOT6JU4/wzMs.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '20.115.26.143' (RSA) to the list of known hosts.
Password: Pa$$w0rd1234

csr#
```

3. Проверьте список интерфейсов с помощью команды **show ip interface brief**. Обратите внимание на то, что второй интерфейс по умолчанию находится в выключенном состоянии.

```
csr#show ip interface brief
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet1       10.1.0.4        YES DHCP   up                    up
GigabitEthernet2       unassigned      YES unset  administratively down down
VirtualPortGroup0      192.168.35.101  YES TFTP   up                    up
```

4. В режиме конфигурации назначьте второму интерфейсу получение IP-адреса через DHCP и включите его. Убедитесь в том, что второй интерфейс включился и получил IP-адрес из ранее созданной подсети **internal**.

```
csr#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
csr(config)#interface GigabitEthernet2
csr(config-if)#no ip dhcp client request router
csr(config-if)#ip address dhcp
csr(config-if)#no shutdown
csr(config-if)#do show ip interface brief
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet1       10.1.0.4        YES DHCP   up                    up
GigabitEthernet2       10.1.1.4        YES DHCP   up                    up
VirtualPortGroup0      192.168.35.101  YES TFTP   up                    up
```

### Создание виртуальной машины во внутренней подсети

1. Внутри вашей группы ресурсов создайте виртуальную машину согласно следующим основным параметрам:

| **Параметр** | **Значение** |
| --- | --- |
| Подписка | Использовать предоставленное по умолчанию |
| Группа ресурсов | Использовать предоставленное по умолчанию |
| Имя виртуальной машины | internal-vm |
| Регион | (US) Восточный регион США |
| Параметры доступности | Избыточность параметров инфраструктуры не требуется |
| Образ | Ubuntu Server 20.04 LTS, поколение 1 |
| Размер | Standard D2s v3 |
| Тип проверки подлинности | Пароль |
| Имя пользователя | azureuser |
| Пароль (внимательно следите за правильностью ввода!) | Pa$$w0rd1234 |
| Правила входящего порта | Разрешить выбранные порты |
| Выбрать входящие порты | SSH (22) |

2. На вкладке «**Диски**» выберите тип ОС диска SSD (цен. Категория «Стандартный»).
3. На вкладке «**Сетевые подключения**» в разделе «**Подсеть**» выберите «**internal**», в разделе «**Общедоступный IP -адрес**» выберите «**Нет**». Оставьте примененные параметры по умолчанию.
4. На вкладке «**Управление**» отключите диагностику загрузки.
5. Нажмите «**Просмотр и создание**» (Review + Create) в нижней части страницы. Ознакомьтесь с параметрами и нажмите «**Создать**» (Create). Создание виртуальной машины займет несколько минут, информация об окончании процесса появится в верхней панели уведомлений.

### Подключение к созданной виртуально машине во внутренней подсесети

1. После того, как виртуальная машина **internal-vm** будет успешно создана, определите ее частный IP-адрес в окне обзора. Так как данная виртуальная машина полностью изолирована во внутренней подсети и не имеет публичного IP-адреса, подключиться к ней необходимо с виртуального маршрутизатора **csr**.

![](/assets/pics/4.10.4.png "Рис. 4.10.4. Обзор виртуальной машины internal-vm")

2. Подключитесь к виртуальному маршрутизатору **csr** по SSH. Проверьте доступность созданной виртуальной машины **internal-vm** с помощью команды **ping**.

```
csr#ping 10.1.1.5
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.1.1.5, timeout is 2 seconds:
.!!!!
Success rate is 80 percent (4/5), round-trip min/avg/max = 1/2/3 ms
```

3. Подключитесь к виртуальной машине по SSH с помощью команды **ssh 10.1.1.5** (без явного указания имени пользователя будет использоваться учетная запись **azureuser** ).

```
csr#ssh 10.1.1.5
Password: Pa$$w0rd1234

# вывод банера сокращен

azureuser@internal-vm:~$
```

4. Проверьте состояние таблицы маршрутизации с помощью команды **ip route**. Обратите внимание, что маршрут по умолчанию установлен через IP-адрес **10.1.1.1**. Данный хост является шлюзом внутреннего SDN-контроллера Azure.

```
azureuser@internal-vm:~$ ip route
default via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100
10.1.1.0/24 dev eth0 proto kernel scope link src 10.1.1.5
168.63.129.16 via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100
169.254.169.254 via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100
```

5. Проверьте доступность любого интернет ресурса (например ya.ru) с помощью команды **ping**. Так как виртуальная машина находится в изолированной подсети, проверка доступности завершиться неуспешно.

```
azureuser@internal-vm:~$ ping -c2 ya.ru
PING ya.ru (87.250.250.242) 56(84) bytes of data.

--- ya.ru ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1018ms
```

### Создание таблицы маршрутизации для внутренней подсети

1. В глобальном каталоге ресурсов выберите «**Таблицы маршрутов**» и в верхней панели нажмите «**+Создать**». Задайте имя таблицы **rt - internal** , оставьте остальные параметры по умолчанию, нажмите «**Просмотр и создание**», проверьте конфигурацию и нажмите «**Создать**».
2. После успешного создания таблицы маршрутизации перейдите к созданному ресурсу. В левом меню в разделе «**Настройки**» выберите «**Подсети**», в верхней панели нажмите «**+Привязать**». В появившейся панели слева выберите вашу виртуальную сеть и подсеть **internal**. Нажмите «**ОК**».
3. В левом меню в разделе «**Настройки**» выберите «**Маршруты**», в верхней панели нажмите «**+Добавить**». В открывшемся окне задайте следующие параметры:

| **Параметр** | **Значение** |
| --- | --- |
| Имя маршрута | default-route |
| Префикс адреса | 0.0.0.0/0 |
| Тип следующего прыжка | Виртуальное устройство |
| Адрес следующего прыжка | 10.1.1.4. |

4. Подключитесь к виртуальному маршрутизатору **csr** и выполните настройку трансляции сетевых адресов.

```
csr#conf t
csr(config)#ip access-list standard ACL_FOR_NAT
csr(config-std-nacl)#permit 10.1.1.0 0.0.0.255
csr(config-std-nacl)#interface GigabitEthernet1
csr(config-if)#ip nat outside
csr(config-if)#interface GigabitEthernet2
csr(config-if)#ip nat inside
csr(config-if)#exit
csr(config)#ip nat inside source list ACL_FOR_NAT interface GigabitEthernet1
csr(config)#exit
csr#
```

5. Подключитесь по SSH к виртуальной машине **internal-vm**. Убедитесь, что настройки маршрутизации внутри операционной системы не изменились с помощью команды **ip route** и выполните проверку доступности любого интернет-ресурса с помощью команды **ping**. Проверка доступности должна пройтиуспешно.

```
csr#ssh 10.1.1.5
Password: Pa$$w0rd1234

azureuser@internal-vm:~$ ip route
default via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100
10.1.1.0/24 dev eth0 proto kernel scope link src 10.1.1.5
168.63.129.16 via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100
169.254.169.254 via 10.1.1.1 dev eth0 proto dhcp src 10.1.1.5 metric 100

azureuser@internal-vm:~$ ping -c2 ya.ru
PING ya.ru (87.250.250.242) 56(84) bytes of data.
64 bytes from ya.ru (87.250.250.242): icmp_seq=1 ttl=235 time=133 ms
64 bytes from ya.ru (87.250.250.242): icmp_seq=2 ttl=235 time=132 ms
--- ya.ru ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 131.913/132.218/132.524/0.305 ms
```