## Лабораторная работа 4.5. Создание виртуальной машины с помощью PowerShell

### Описание сценария

Сценарии на языке PowerShell являются мощным инструментом автоматизации рутинных задач в информационной инфраструктуре, в том числе и для автоматического управления ресурсами инфраструктуры облака Azure

В данном сценарии системный администратор создает сценарий автоматизированного развертывания виртуальной машины с использованием PowerShell.

### Задачи лабораторной работы

- Настроить оболочку CloudShell
- Создать виртуальную машину с помощью сценария PowerShell
- Изучить команды PowerShell для управления состояния виртуальных машин

### Настройка Cloud Shell  на портале  Azure

1. Войдите на портал Azure по адресу **portal.azure.com** под вашей учетной записью.
2. Создайте группу ресурсов или используйте группу ресурсов, выделенную для вашей учетной записи.
3. В верхней панели портала нажмите на значок терминала (справа от строки поиска), после чего в нижней части страницы откроется раздел терминала **Azure Cloud Shell** , где будет предложено выбрать **Bash** или **PowerShell**. Выберите **PowerShell**.

![](/assets/pics/4.5.1.png "Рис. 4.5.1. Azure Cloud Shell")

4. Появится сообщение о том, что у вас не подключено хранилище. Выберите «Показать дополнительные настройки» и введите следующие параметры.

| **Параметр** | **Значение** |
| --- | --- |
| Подписка | Использовать предоставленное по умолчанию |
| Группа ресурсов | Использовать предоставленное по умолчанию |
| Учетная запись хранения (создать новую) | cloudshellxxxxx (замените **xxxxx** таким образом, чтобы имя учетной записи было уникальным) |
| Регион Cloud Shell | Восточная часть США |
| Общая папка (создать новую) | shellstorage |

### Создание виртуальной машины с помощью PowerShell

1. После запуска CloudShell убедитесь в том, что в левом верхнем углу терминала выбрана опция **PowerShell**.
2. Просмотрите информацию о доступных вам группах ресурсов с помощью команды **Get-AzResourceGroup | Format-Table**.
3. Запустите создание виртуальной машины, с помощью следующей команды в терминале:

```
New-AzVm `
-ResourceGroupName "имя-вашей-группы-ресурсов" `
-Name "myVMPS" `
-Location "East US" `
-VirtualNetworkName "myVnetPS" `
-SubnetName "mySubnetPS" `
-SecurityGroupName "myNSGPS" `
-PublicIpAddressName "myPublicIpPS"
```

Обратите внимание, что в конце каждой строки используется апостроф (`) для переноса команды на следующую строку, альтернативно вся команда может быть написана в одну строку.

1. При появлении запроса укажите имя пользователя **azureuser** и пароль **Pa$$w0rd1234** , которые будут настроены в качестве учетной записи локального администратора на этих виртуальных машинах. Если в сценарии не указывается размер и тип виртуальной машины, по умолчанию создается виртуальная машина WindowsServerDatacenter 2016 размера **Standard D2s v3**.
2. После того, как CloudShell завершит операцию, перейдите в свою группу ресурсов, в верхней панели нажмите обновить и проверьте, что все перечисленные в сценарии ресурсы либо созданы, либо отправлены в очередь на создание.

![](/assets/pics/4.5.2.png "Рис. 4.5.2. Результат работы сценария PowerShell")

### Управление состоянием виртуальной машины с помощью PowerShell

1. Для получения текущего статуса виртуальной машины выполните в терминале команду **Get-AzVM -name myVMPS -status | Format-Table -autosize**.

```
PS /home/lab> Get-AzVM -name myVMPS -status | Format-Table -autosize                                                    

ResourceGroupName   Name Location VmSize          OsType  NIC    Provisioning PowerState
-----------------   ---- -------- ------          ------  ---    ------------ -----
RG-LABUSER        myVMPS   eastus Standard_D2s_v3 Windows myVMPS    Succeeded VM running
```

2. Для остановки виртуальной машины используйте команду **Stop -AzVM -Name myVMPS**. Введите имя вашей ресурс группы и при появлении запроса об остановке подтвердите действие (Y). Подождите до отображения состояния успешного выполнения.

```
PS /home/lab> Stop-AzVM -Name myVMPS

cmdlet Stop-AzVM at command pipeline position 1
Supply values for the following parameters:
(Type !? for Help.)
ResourceGroupName: имя-вашей-группы-ресурсов

Virtual machine stopping operation
This cmdlet will stop the specified virtual machine. Do you want to continue?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y

OperationId : b5003206-257c-4179-b70d-3081b703b359
Status      : Succeeded
StartTime   : 12/4/2021 3:45:24 PM
EndTime     : 12/4/2021 3:46:12 PM
Error       :
```

3. Откройте виртуальную машину на портале и убедитесь в том, что она остановлена.

![](/assets/pics/4.5.3.png "Рис. 4.5.3. Результат остановки виртуальной машины")
